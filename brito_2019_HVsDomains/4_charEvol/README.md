# Reconstructing character evolution

This is the last step of the pipeline. It uses the output of [Mesquite](https://www.mesquiteproject.org/) to reconstruct character (domain) evolution along a given phylogeny using `charEvol.py`. In the context of domain evolution, character states can be represented as a matrix of protein domain counts per genome, generated in the previous step by `domMatrix.py`. Based on such matrix, `Mesquite` can estimate events of character gain, loss and duplication along the branches of a tree using a Parsimony model. This model reconstructs the ancestral states (number of domains) at the internal nodes of a tree, while trying to minimise the number of changes (events) given the phylogeny and the matrix (domain distribution).


## Running Mesquite

First, download and install `Mesquite` ([click here](https://www.mesquiteproject.org/Installation.html)). For reconstructing the number of domains encoded by ancestral genomes, `Mesquite` requires two files as input: (1) a matrix of domain counts, and; (2) a species tree (Newick format), with taxa named as they appear in the matrix. To run the software, both matrix and tree must be combined into Mesquite following the steps below:

1. Copy the entire content of the matrix generated by `domMatrix.py` in text format;
2. Open the target time-calibrated Beast tree on Mesquite ('File' > 'Open File');
3. Go to Menu 'Characters' > 'Make new matrix from' > 'Clipboard' > Select 'Meristic' as data category. To ensure the correct formatting of the matrix, below 'Data type', select 'Includes character names' and 'Includes taxon names'. Click 'Ok', name the matrix, and it will be shown as a tab.

Now, both tree and matrix are associated in the same 'Mesquite Project', allowing you to run a ['Character history' analysis](http://mesquiteproject.org/mesquiteArchives/mesquite2.75/Mesquite_Folder/docs/mesquite/CharacterEvolution/AncestralStates.html). To do so:

4. Select the tab containing the tree, and access the menu 'Analysis:Tree' > 'Trace all characters'. Select 'Parsimony Ancestral state' as the reconstruction method;
5. Make sure the terminal nodes (tips of the tree) are represented in the matrix: access the menu 'Trace_All', and select 'Show Terminal Nodes';
6. Select the tab containing the newly generated matrix (tab 'Trace All Characters'), and save it as a text file on 'File' > 'Save Window as Text'.

## Running charEvol.py

### Dependencies

For running `charEvol.py`, the following Python3 packages must be installed:

* DateTime
* NetworkX

### Execution

After running `Mesquite`, your working directory may contain all files required for running `charEvol.py` with a command line similar to the one shown below:

```
python charEvol.py --tree beast.tree --matrix1 domain_matrix.txt --matrix2 mesquite_matrix.txt
```

where `beast.tree` is a time-calibrated beast tree; `domain_matrix.txt` is the file generated by `domMatrix.py`;  and `mesquite_matrix.txt` is the file exported at the step 6 described above. After running `charEvol.py`, the working directory will now include a folder named 'results', containing an additional folder named with the date and time the script was executed. The output files describe a plausible scenario explaining the dynamics of domain evolution for the species included in the tree. In that dated directory one can find the results stored in two folders:
* 'itol_annotations': showing an itol formatted tree, as well as 'domain' and 'label' files to annotate the tree. [Click here](https://itol.embl.de/tree/13013217350409021551825529#) to see an example, where squares represent events of domain gain (green), loss (white), and duplication (purple);
* 'raw_outputs': showing a set of files showing a list of events reconstructed per branch, a custom domain legend file, a file listing all domains involved in events of gain, loss, and duplication; as well as a transposed version of the mesquite matrix, for inspection.

See `input` and `output` directories for more details about input and output files.

## Author

* **Anderson Brito** - [WebPage](https://andersonbrito.github.io/) - andersonfbrito@gmail.com

## License

This project is licensed under the MIT License.
